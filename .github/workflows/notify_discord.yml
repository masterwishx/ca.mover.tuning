name: Notify Discord on New Issue

on:
  issues:
    types: [opened]

jobs:
  discord_notification:
    runs-on: ubuntu-latest
    steps:
      - name: Send rich embed to Discord
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          TITLE: ${{ github.event.issue.title }}
          URL: ${{ github.event.issue.html_url }}
          NUMBER: ${{ github.event.issue.number }}
          USER: ${{ github.event.issue.user.login }}
          BODY: ${{ github.event.issue.body }}
          LABELS: ${{ join(github.event.issue.labels.*.name, ', ') }}
        run: |
          # Ensure safe defaults
          DESCRIPTION=$(echo "${BODY:-}" | head -c 200 | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
          [ -z "$DESCRIPTION" ] && DESCRIPTION="*(No description provided)*"
          [ -z "$LABELS" ] && LABELS="None"

          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          JSON=$(cat <<EOF
          {
            "content": "ðŸ†• New GitHub Issue Created",
            "embeds": [
              {
                "title": "Issue #${NUMBER}: ${TITLE}",
                "url": "${URL}",
                "description": "${DESCRIPTION}",
                "color": 5814783,
                "fields": [
                  {
                    "name": "Author",
                    "value": "${USER}",
                    "inline": true
                  },
                  {
                    "name": "Labels",
                    "value": "${LABELS}",
                    "inline": true
                  }
                ],
                "timestamp": "${TIMESTAMP}"
              }
            ]
          }
          EOF
          )

          echo "Sending payload to Discord..."
          echo "$JSON"
          curl -H "Content-Type: application/json" -d "$JSON" "$WEBHOOK"
